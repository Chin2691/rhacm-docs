[#argo-pull-model]
= Deploying Argo CD with the pull model
//discuss placement

The Argo CD server on the hub cluster deploys the application resources on the managed clusters. Pull model implementation applies {ocm} registration, placement, and `manifestWork` APIs so that the hub cluster can use the secure communication channel between the hub cluster and the managed cluster to deploy resources. 

With this model, an Argo CD controller must be running on each target managed cluster so that the Argo CD  `ApplicationSet` can use a single manifest to deploy an application on multiple managed clusters. The same `ApplicationSet` CRD is used to deploy the application to the managed cluster using the push or pull model. 

*Required access:* Cluster administrator

[#pull-model-arch]
== Pull model architecture

The `apps.open-cluster-management.io/ocm-managed-cluster` annotation is required in
the template section of the `ApplicationSet` resource. This annotation is used to specify the target managed cluster for the application. 

*Important:* For pull model, the `local-cluster` is excluded as target managed cluster.

See the following information about pull model architecture:

- The _propagation controller_ is added to the hub cluster and watches for applications that contain the
`ocm-managed-cluster` annotation. 

- The propagation controller creates a `manifestWork` to deliver the application to the managed cluster.

- The Argo CD `ApplicationSet` controller on the hub cluster reconciles to create application resources for each target managed cluster.

- The Propagation controller on the hub cluster also reconciles the application resources and creates a `manifestWork` to deliver the application to the managed clusters.
//we say this already?

- The Argo CD application controller on the managed cluster reconciles to deploy the application.

- The _Resource sync controller_ on the hub cluster queries the {ocm} search V2 component on each managed cluster periodically to retrieve the resource list and any error messages for each Argo CD application.

- THe _Aggregation controller_ on the hub cluster creates and updates the multicluster `ApplicationSet` report by using the data from the resource sync controller and the status information from the `manifestWork` for the applications.
____

[#prereqs-pull-model]
== Prerequisites 

See the following prerequisites for the Argo CD pull model:

- The GitOps operator must be installed on the hub cluster and the target managed clusters in the `openshift-gitops` namespace. *Note* Use the {ocp-short} OperatorHub to install the GitOps operator, where the default namespace is `openshift-gitops`.

- The required hub cluster {ocp-short} GitOps operator must be version 1.9.0 or later. 

- The required managed clusters {ocp-short} GitOps operator must be the same version as the hub cluster.

- Every managed cluster must have a cluster secret in the Argo CD server namespace on the hub cluster.

- You need the `ApplicationSet` controller to propagate the Argo CD application template for a managed cluster.

- The GitOps cluster resource must contains a reference to a placement resource, since the placement resource selects all the managed clusters that support the pull model. With this prerequisite, the managed cluster secrets are created in the Argo CD server namespace.

+
See the following example where name: `book-app-placement` is a `placementRef` that can select all clusters:

+
[source,yaml]
----
apiVersion: apps.open-cluster-management.io/v1beta1
kind: GitOpsCluster
metadata:
  name: argo-acm-importer
  namespace: openshift-gitops
spec:
  argoServer:
    cluster: notused
    argoNamespace: openshift-gitops
  placementRef:
    kind: Placement
    apiVersion: cluster.open-cluster-management.io/v1beta1
    name: book-app-placement      
    namespace: openshift-gitops
----

*Information:* If the `openshift-gitops-ArgoCD-application-controller` service account is not a cluster administrator, the GitOps application controller might not have the required permission to deploy resources. The application status might send an error similar to the following error:
//I feel this is misplaced -- we need the RBAC stated early but if there is more info needed, this may be more for a known issue?

----
cannot create resource "services" in API group "" in the namespace
"mortgage",deployments.apps is forbidden: User
"system:serviceaccount:openshift-gitops:openshift-gitops-Argo CD-application-controller"
----

To avoid this issue, see the following procedure:

. Create all namespaces on each managed cluster where the Argo CD application will be deployed.

. Add the `managed-by` label to each namespace. If an Argo CD application is deployed to multiple namespaces,
each namespace should be managed by Argo CD. See the following example:

+
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  name: mortgage2
  labels:
    Argo CD.argoproj.io/managed-by: openshift-gitops
----

. Explicitly declare all application destination namespaces in the repository for the application and include the `managed-by` label in the namespaces. Refer to _Additional resources_ to learn how to declare a namespace.
//add name of link if this stays in the topic

To deploy applications by using the pull model, the Argo CD application controllers must ignore these application resources on the hub cluster. Add the `Argo CD.argoproj.io/skip-reconcile` annotation to the template section of the  `ApplicationSet`. 

[#crd-pull-model]
== `ApplicationSet` CRD
//I wonder if this is for push and pull and should be on it's own

The Argo CD `ApplicationSet` CRD is used to deploy applications on the managed clusters by using the push or pull model with a placement resource in the generator field that is used to get a list of managed clusters. 

The template field supports parameter substitution of specifications for the application. The Argo CD `ApplicationSet` controller on the hub cluster manages the creation of the application for each target cluster.

For the pull model, the destination for the application must be the default local Kubernetes server, since the application is deployed locally by the application controller on the managed cluster. 

By default, the push model is used to deploy the application, unless the annotations `apps.open-cluster-management.io/ocm-managed-cluster` and `apps.open-cluster-management.io/pull-to-ocm-managed-cluster` are added to the template section of the `ApplicationSet`.

The following is a sample `ApplicationSet` YAML that uses the pull model with template annotations:

+
[source,yaml]
----
apiVersion: argoproj.io/v1alpha1
kind: `ApplicationSet`
metadata:
  name: guestbook-allclusters-app-set
  namespace: openshift-gitops
spec:
  generators:
  - clusterDecisionResource:
      configMapRef: ocm-placement-generator
      labelSelector:
        matchLabels:
          cluster.open-cluster-management.io/placement: aws-app-placement
      requeueAfterSeconds: 30
  template:
    metadata:
      annotations:
        apps.open-cluster-management.io/ocm-managed-cluster: '{{name}}'
        apps.open-cluster-management.io/ocm-managed-cluster-app-namespace: openshift-gitops
        Argo CD.argoproj.io/skip-reconcile: "true"
      labels:
        apps.open-cluster-management.io/pull-to-ocm-managed-cluster: "true"
      name: '{{name}}-guestbook-app'
    spec:
      destination:
        namespace: guestbook
        server: https://kubernetes.default.svc
      project: default
      source:
        path: guestbook
        repoURL: https://github.com/argoproj/Argo CD-example-apps.git
      syncPolicy:
        automated: {}
        syncOptions:
        - CreateNamespace=true
----

[#propagation-controller]
== Propagation controller

Two sets of controllers on the hub cluster watch the `ApplicationSet` resources _Argo CD application controllers_ and the _Propagation controller_. Annotations in the application resource are used to determine which controller reconciles to deploy the application for either the push model or the pull model.

- The Argo CD application controller is used for the push model and ignores applications that contain the Argo CD `argoproj.io/skip-reconcile` annotation. 

- The propagation controllers, which support the pull model, only reconcile on applications that contain the `apps.open-cluster-management.io/ocm-managed-cluster` annotation and generates a `manifestWork` to deliver the application to the managed cluster. The managed cluster is determined by the value of the `ocm-managed-cluster` annotation.
//I feel this last line is misplaced

The following is a sample `manifestWork` YAML file that is generated by the Propagation controller to create the `guestbook` application on the managed cluster `pcluster2`:

+
[source,yaml]
----
apiVersion: work.open-cluster-management.io/v1
kind: `manifestWork`
metadata:
  annotations:
    apps.open-cluster-management.io/hosting-applicationset: openshift-gitops/guestbook-allclusters-app-set
 name: pcluster2-guestbook-app-4a491
  namespace: pcluster2
spec:
  manifestConfigs:
  - feedbackRules:
    - jsonPaths:
      - name: healthStatus
        path: .status.health.status
      type: JSONPaths
    - jsonPaths:
      - name: syncStatus
        path: .status.sync.status
      type: JSONPaths
    resourceIdentifier:
      group: argoproj.io
      name: pcluster2-guestbook-app
      namespace: openshift-gitops
      resource: applications
  workload:
    manifests:
    - apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        annotations:
          apps.open-cluster-management.io/hosting-applicationset: openshift-gitops/guestbook-allclusters-app-set
        finalizers:
        - resources-finalizer.Argo CD.argoproj.io
        labels:
          apps.open-cluster-management.io/application-set: "true"
        name: pcluster2-guestbook-app
        namespace: openshift-gitops
      spec:
        destination:
          namespace: guestbook
          server: https://kubernetes.default.svc
        project: default
        source:
          path: guestbook
          repoURL: https://github.com/argoproj/Argo CD-example-apps.git
        syncPolicy:
          automated: {}
          syncOptions:
          - CreateNamespace=true
----

As a result of the feedback rules that are specified in `manifestConfigs`, the health status and the sync status from the status of the Argo CD application are synced to the `manifestWork` `statusFeedback`. Deploy application by the local Argo CD server on the managed cluster.
//I don't understand this

After the Argo CD application is created on the managed cluster with `manifestWork, the local Argo CD controllers reconcile to deploy the application. The controllers deploy the application with the following sequence of operations:

- The controllers connect and pull resources from the specified repository.

- The controllers deploy the resources on the local managed cluster.

- The Multicluster Application status report, which aggregates application status from the managed clusters, is generated.
//this?

- A new multicluster `ApplicationSet` report CRD is introduced to provide an aggregate status of the `ApplicationSet` on the hub cluster. The report is only created for `ApplicationSet` resources that are deployed using the pull model and includes the list of resources and the overall status of the application from each managed cluster. 
//same thing here?

- A separate multicluster `ApplicationSet` report resource is created for each Argo CD `ApplicationSet` resource. The report is created in the same namespace as the `ApplicationSet`. 

The Multicluster `ApplicationSet` report includes the following items:

- A list of resources for the Argo CD application
- the overall sync and health status for one Argo CD application
- An error message for each cluster where the overall status is `out of sync` or `unhealthy`
- Summary status of the overall application status from all the managed clusters

To support the generation of the `ApplicationSet` report, two controllers are added to the hub cluster:
//we already introduced these?

- The _Resource sync controller_, which runs every 10 seconds to query the {ocm} search V2 component on each managed cluster to retrieve the resource list and any error messages for each Argo CD application. It produces an intermediate report for each `ApplicationSet`, which is intended to be used by the aggregation controller to generate the final multicluster `ApplicationSet` report.

- The _Aggregation controller_, which also runs every 10 seconds and uses the report generated by the resource sync controller to add the health and sync status of the application on each managed cluster. The status for each application is retrieved from the status feedback in the `manifestWork` for the application. After the aggregation is complete, the final multicluster `ApplicationSet` report is saved in the same namespace as the Argo CD `ApplicationSet`, with the same name as the `ApplicationSet`.

The two new controllers, along with the propagation controller, all run in separate containers in the same `multicluster-integrations` pod, as shown in the following example output:

----
NAMESPACE               NAME                                       READY   STATUS  
open-cluster-management multicluster-integrations-7c46498d9-fqbq4  3/3     Running  
----

The following is a sample multicluster `ApplicationSet` report YAML for the guestbook `ApplicationSet`:

+
[source,yaml]
----
apiVersion: apps.open-cluster-management.io/v1alpha1
kind: MulticlusterApplicationSetReport
metadata:
  labels:
    apps.open-cluster-management.io/hosting-applicationset: openshift-gitops.guestbook-allclusters-app-set
  name: guestbook-allclusters-app-set
  namespace: openshift-gitops
statuses:
  clusterConditions:
  - cluster: cluster1
    conditions:
    - message: 'Failed sync attempt to 53e28ff20cc530b9ada2173fbbd64d48338583ba: one or more objects failed to apply, reason: services is forbidden: User "system:serviceaccount:openshift-gitops:openshift-gitops-Argo CD-application-controller" cannot create resource "services" in API group "" in the namespace "guestbook",deployments.apps is forbidden: User "system:serviceaccount:openshift-gitops:openshift-gitops-Argo CD-application-controller" cannot create resource "deployments" in API group "apps" in the namespace "guestboo...'
      type: SyncError
    healthStatus: Missing
    syncStatus: OutOfSync
  - cluster: pcluster1
    healthStatus: Progressing
    syncStatus: Synced
  - cluster: pcluster2
    healthStatus: Progressing
    syncStatus: Synced
  summary:
    clusters: "3"
    healthy: "0"
    inProgress: "2"
    notHealthy: "3"
    notSynced: "1"
    synced: "2"
----

All the resources that are listed in the multicluster `ApplicationSet` report are actually deployed on the managed cluster. If a resource fails to deploy, the resource is not included in the resource list. However, the error message indicates why the resource failed to be deployed.


== Additional resources
//change these

https://docs.openshift.com/container-platform/4.11/cicd/gitops/configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations.html#creating-an-application-by-using-the-oc-tool_configuring-an-openshift-cluster-by-deploying-an-application-with-cluster-configurations (will not be using this--replace)

https://github.com/redhat-developer-demos/openshift-gitops-examples/blob/44fc1d4a38cb79ffa6c8524788f5ac87f369d41c/apps/bgd/overlays/bgd/bgd-ns.yaml#L6 (will not be using this-replace

(https://kubernetes.default.svc))

