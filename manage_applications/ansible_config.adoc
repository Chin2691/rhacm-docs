[#setting-up-ansible]
== Setting up Ansible Tower tasks (Technology preview)

{product-title-short} is integrated with Ansible Tower automation so that you can create prehook and posthook AnsibleJob instances for Git subscription application management. With Ansible Tower jobs, you can automate tasks and integrate with external services, such as Slack and pager duty services. Your Git repository resource root path will contain `prehook` and `posthook` directories for Ansible Tower jobs that run as part of deploying the app, updating the app, or removing the app from a cluster.

*Required access:* Cluster administrator

[#prerequisites-for-ansible-integration]
== Prerequisites 

* You must have Ansible Tower version 3.7.3 or a later version installed. It is best practice to install the latest supported version. See link:https://docs.ansible.com/ansible-tower/[Red Hat AnsibleTower documentation] for more details about Ansible Tower.

[#ansible-integration]
== Ansible integration

You can integrate Ansible Tower jobs into Git subscriptions. For instance, for a database front-end and back-end application, the database is required to be instantiated using Ansible Tower with an Ansible Job, and the application is installed by a Git subscription. The database is instantiated _before you deploy the front-end and back-end application with the subscription.

The application subscription operator is enhanced to define two subfolders: `prehook` and `posthook`. Both folders are in the Git repo resource root path and contain all prehook and posthook Anible jobs, respectively.

When the Git subscription is created, all of the pre and post AnsibleJob resources are parsed and stored in memory as an object. The application subscription controller decides when to create the pre and post AnsibleJob instances.

[#install-ansible-operator]
== Install Ansible operator

To get started, you need to install the Ansible Automation Platform Resource Operator to connect Ansible jobs to the lifecycle of Git subscriptions. For best practice when using the AnsibleJob to launch Ansible Tower jobs, the Ansible Tower job template should be idempotent when ran. 

Check `PROMPT ON LAUNCH` on the template for both INVENTORY and EXTRA VARIABLES. See link:https://docs.ansible.com/ansible-tower/latest/html/userguide/job_templates.html[Job templates] for more information.

To install, complete the following procedure.

. Log in to your {ocp-short} cluster console.
. Click *OperatorHub* in the console navigation.
. Search for and install the _Ansible Automation Platform Resource Operator_.

[#ansible-operator-components]
== Ansible operator components

When you create a subscription CR, the Git-branch and Git-path points to a Git repository root location. In the Git root location, the two subfolders `prehook` and `posthook` should contain at least one `AnsibleJob` `Kind` resource.

[#prehook]
=== Prehook

The application subscription controller searches all the `AnsibleJob` `Kind` CRs in the prehook folder as the prehook AnsibleJob objects, then generates a new prehook AnsibleJob instance. The new instance name is the prehook AnsibleJob object name and a random suffix string. For example, see `database-sync-1-2913063`.

The application subscription controller queues the reconcile request again in a 1 minute loop, where it checks all the prehook AnsibleJob `status.anisibleJobResult`. When the prehook `status.ansibleJobResult.status` is `successful` the application subscription continues to deploy the main subscription.

[#posthook]
=== Posthook

When the app subscription status is updated, if the subscription status is subscribed or propagated to all target clusters in subscribed status, the app subscription controller searches all the `AnsibleJob` `Kind` CRs in the posthook folder as the posthook AnsibleJob objects. Then, it generates new posthook `AnsibleJob` instances. The new instance name is the posthook `AnsibleJob` object name and a random suffix string. For example, see `service-ticket-1-2913849`.
[#ansible-placement-rule]
=== Ansible placement rules

If there is a valid prehook AnsibleJob, the subscription launches the prehook AnsibleJob regardless of the decision from the placementrule. For example, you can have a prehook AnsibleJob that failed to propagate a placement rule subscription. Whenever the placement rule decision changes, new prehook and posthook AnsibleJob instances created are created.


[#ansible-configuration]
== Ansible configuration

With the following tasks, you can configure Ansible Tower configurations:

[#ansible-secrets]
=== Ansible secrets

You must create an Ansible Tower secret CR in the same subscription namespace. The Ansible Tower secret is limited to the same subscription namespace.

Create the secret from the console by filling in the `Ansible Tower secret name` section. To create the secret using terminal, edit and apply the following `yaml`:

*Notes:* The `namespace` is the same namspace as the subscription namespace. The `string data` `token` and `host` are from the Ansible Tower.

----
apiVersion: v1
kind: Secret
metadata:
  name: toweraccess
  namespace: same-as-subscription
type: Opaque
stringData:
  token: ansible-tower-api-token
  host: https://ansible-tower-host-url
----

When the app subscription controller creates prehook and posthook AnsibleJobs, if the secret from subscription `spec.hooksecretref` is available, then it is sent to the AnsibleJob CR `spec.tower_auth_secret` and the AnsibleJob is able to access the Ansible Tower.

[#ansible-secret-reconciliation]
== Set secret reconciliation

For a main-sub subscription with prehook and posthook AnsibleJobs, the main-sub subscription should be reconciled after all prehook and posthook AnsibleJobs or main subscription are updated in the Git repo. 

. Prehook AnsibleJobs and the main subscription continuously reconcile and relaunch a new pre-AnsibleJob instance.

. After the pre-AnsibleJob is done, re-run the main subscription. If there is any spec change in the main subscription, re-deploy the subscription. 

. The main subscription status should be updated to align with the redeployment procedure. 

. Reset the hub subscription status to `nil` and it will be refreshed along with the subscription deployment on target clusters. 

When the deployment is finished on the target cluster, the subscription status on the target cluster is updated to `"subscribed"` or `“failed”`, and will be synced up to the hub cluster subscription status.

. After the main subscription is done, relaunch a new post-AnsibleJob instance

. Verify that the DONE subscription is updated:

- subscription.status == “subscribed”
- subscription.status == “propagated” and all of the target clusters are “subscribed”

[#check-ansible-job]
== Check Ansible job status

When a AnsibleJob CR is created, A Kubernetes job CR is created to launch an Ansible Tower job by communicating to the target Ansible Tower. When the job is complete, the final status for the job is returned to AnsibleJob `status.ansibleJobResult`. 

*Note:* the AnsibleJob status.conditions is reserved by the Ansible Job operator for storing the creation of Kubernetes job result. It does not reflect the actual Ansible Tower job status. The subscription controller checks the Ansible Tower job status by its `AnsibleJob.status.ansibleJobResult` instead of `AnsibleJob.status.conditions`.

As previously mentioned in the prehook and posthook AnsibleJob workflow, whenever the main subscription is updated in Git repo, a new prehook and posthook AnsibleJob instance is created. As a result, one main subscription could link to multiple AnsibleJob instances. 

Four fields are defined in subscription.status.ansibleJobs:

- lastPrehookJobs: The most recent prehook AnsibleJobs
- prehookJobsHistory: All the prehook AnsibleJobs history
- lastPosthookJobs: The most recent posthook AnsibleJobs
- posthookJobsHistory: All the posthook AnsibleJobs history
