[#creating-a-cluster-on-amazon-web-services]
= Creating a cluster on Amazon Web Services

You can use the {mce} console to create a {ocp} cluster on Amazon Web Services (AWS) or on AWS GovCloud. The few differences are identified in the procedure.  

AWS GovCloud provides cloud services that meet additional requirements that are required to store government documents on the cloud. When you create a cluster on AWS GovCloud, you must complete additional steps to prepare your environment.

When you create a cluster, the creation process uses the {ocp-short} installer with the Hive resource. If you have questions about cluster creation after completing this procedure, see https://access.redhat.com/documentation/en-us/openshift_container_platform/4.12/html/installing/installing-on-aws[Installing on AWS] in the {ocp-short} documentation for more information about the process.  

* <<aws_prerequisites,Prerequisites>>
* <<aws-creating-your-cluster-with-the-console,Creating your cluster with the console>>

[#aws_prerequisites]
== Prerequisites

The following prerequisites are separated into general prerequisites for both AWS and AWS GovCloud. The general prerequisites apply to both cases.

* Standard AWS cluster creation prerequisites:

** You need Internet access for your {mce} hub cluster so it can create the Kubernetes cluster on Amazon Web Services.

** You need an AWS credential. See xref:../credentials/credential_aws.adoc#creating-a-credential-for-amazon-web-services[Creating a credential for Amazon Web Services] for more information.

** You need a configured domain in AWS. See https://access.redhat.com/documentation/en-us/openshift_container_platform/4.12/html/installing/installing-on-aws#installing-aws-account[Configuring an AWS account] for instructions on how to configure a domain.

** You must have Amazon Web Services (AWS) login credentials, which include user name, password, access key ID, and secret access key. See https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html[Understanding and Getting Your Security Credentials].

** You must have an {ocp-short} image pull secret. See https://access.redhat.com/documentation/en-us/openshift_container_platform/4.12/html/images/managing-images#using-image-pull-secrets[Using image pull secrets].

* AWS GovCloud specific prerequisites:

** You must have an Amazon Virtual Private Cloud (VPC) with an existing {ocp} cluster for the hub cluster. The hub cluster name for this example is `hub-vpc` and uses {ocp-short} 4.11.13 with {mce} version 2.2 or {product-title} version 2.7 installed. This VPC must be different from the VPCs that are used for the managed cluster resources or the managed cluster service endpoints.

** You need a VPC where the managed cluster resources are deployed. This cannot be the same as the VPCs that are used for the hub cluster or the managed cluster service endpoints. 

** You need one or more VPCs that provide the managed cluster service endpoints. This cannot be the same as the VPCs that are used for the hub cluster or the ACM managed cluster resources.

** Ensure that the IP addresses of the VPCs that are specified by the Classless Inter-Domain Routing (CIDR) for the required VPCs do not overlap.

** You need a `HiveConfig` file that references a credential within the Hive namespace that has access to create resources on the VPC that you created for the ACM managed cluster resources.

*Note:* If you change your cloud provider access key on the cloud provider, you also need to manually update the corresponding credential for the cloud provider on the console of {mce}. This is required when your credentials expire on the cloud provider where the managed cluster is hosted and you try to delete the managed cluster.

[#configuring-hive-to-enable-private-link-aws-gov]
== Configuring Hive to enable a private link on AWS GovCloud

While creating a cluster on AWS GovCloud is almost identical to creating a cluster on standard AWS, you have to complete some additional steps to prepare a private link for the cluster on AWS GovCloud.

[#create-vpcs-aws-govcloud]
=== Create the VPCs for resources and endpoints

As listed in the prerequisites, two VPCs are required in addition to the VPC that contains the hub cluster. See https://docs.aws.amazon.com/vpc/latest/userguide/working-with-vpcs.html#Create-VPC[Create a VPC] in the Amazon Web Services documentation for specific steps for creating a VPC.

. Create a VPC for the managed cluster with private subnets. For this example, this VPC is named `managed01-vpc`.

. Create one or more VPCs for the managed cluster service endpoints with private subnets.
+
*Note:* Each VPC in a region has a limit of 255 VPC endpoints, so you need multiple VPCs support more clusters in that region.

. For each VPC, create subnets in all of the supported availability zones of the region. Each subnet must have at least 255 usuable IPs because of the controller requirements.
+
The following example shows how to complete subnets for VPCs that have 6 availability zones in the `us-east-1` region:
----
vpc-1 (us-east-1) : 10.0.0.0/20
  subnet-11 (us-east-1a): 10.0.0.0/23
  subnet-12 (us-east-1b): 10.0.2.0/23
  subnet-13 (us-east-1c): 10.0.4.0/23
  subnet-12 (us-east-1d): 10.0.8.0/23
  subnet-12 (us-east-1e): 10.0.10.0/23
  subnet-12 (us-east-1f): 10.0.12.0/2

vpc-2 (us-east-1) : 10.0.16.0/20
  subnet-21 (us-east-1a): 10.0.16.0/23
  subnet-22 (us-east-1b): 10.0.18.0/23
  subnet-23 (us-east-1c): 10.0.20.0/23
  subnet-24 (us-east-1d): 10.0.22.0/23
  subnet-25 (us-east-1e): 10.0.24.0/23
  subnet-26 (us-east-1f): 10.0.28.0/23
----

. Make sure all of the {mce} hub environments ({mce} hub cluster VPCs) have network reachability to the VPCs that you created for VPC endpoints that use peering, transit gateways, and so on.

. Create a list of VPCs that need to resolve the DNS setup for the private link. This includes at least the VPC of the {mce} being configured, and can include the list of all of the VPCs where various Hive controllers exist.

[#configure-vpcs-aws-govcloud]
=== Configure the VPCs for resources and endpoints

Configure the peer connections, route tables, and security groups for the VPCs that you created. 

. Configure the peer connections and ensure that each peer connection is successfully accepted by both clusters in the connection. 

.. Create a peer connection named `px-s01-h01` that connects `managed01-vpc` and `hub01-vpc`.

.. Create a peer connection named `px-s01e-h01` that connects `managed01-e-vpc` and `hub01-vpc`.

.. Create a peer connection named `px-s01-s01e` that connects `managed01-vpc` and `managed01-e-vpc`.

. Ensure that all DNS settings are enabled.

. Configure the route tables by completing the following steps:

.. Update all of the `*-private` route tables for `managed01-vpc`.

... Add an entry with the destination of `hub01-vpc` CIDR to peer connection `px-s01-h01`.

... Add an entry with the destination of `managed01-e-vpc` CIDR to peer connection `px-s01-s01e`.

.. Update all of the `*-private` route tables for `managed01-e-vpc`.

... Add an entry with the destination of `hub01-vpc` CIDR to peer connection `px-s01e-h01`.

... Add an entry with destination of `managed01-vpc` CIDR to peer connection `px-s01-s01e`.

.. Update all of the `*-private` route tables for `hub01-vpc`.

... Add an entry with the destination of `managed01-e-vpc` CIDR to peer connection `px-s01e-h01`.

... Add an entry with destination of `managed01-vpc` CIDR to peer connection `px-s01-h01`.

. Configure the security groups.
+ 
Each VPC endpoint in AWS has a security group attached to control access to the endpoint. When Hive creates a VPC endpoint, it does not specify a security group. The default security group of the VPC is attached to the VPC endpoint. The default security group of the VPC must have rules to allow traffic where VPC endpoints are created from the Hive installer pods. See the [docs][control-access-vpc-endpoint] for details.

For example, if Hive is running in `hive-vpc(10.1.0.0/16)`, there must be a rule in the default
security group of the VPC where the VPC endpoint is created that allows ingress from `10.1.0.0/16`.

[#set-permissions-for-aws-private-link]
=== Set permissions for the AWS private link

You need multiple credentials to configure the AWS private link. The required permissions for these credentials depends on the type of credential.

* The credentials for ClusterDeployment require the following permissions:
+
----
ec2:CreateVpcEndpointServiceConfiguration
ec2:DescribeVpcEndpointServiceConfigurations
ec2:ModifyVpcEndpointServiceConfiguration
ec2:DescribeVpcEndpointServicePermissions
ec2:ModifyVpcEndpointServicePermissions
ec2:DeleteVpcEndpointServiceConfigurations
----

* The credentials for HiveConfig for endpoint VPCs account `.spec.awsPrivateLink.credentialsSecretRef` require the following permissions: 
---- 
ec2:DescribeVpcEndpointServices
ec2:DescribeVpcEndpoints
ec2:CreateVpcEndpoint
ec2:CreateTags
ec2:DescribeNetworkInterfaces
ec2:DescribeVPCs

ec2:DeleteVpcEndpoints

route53:CreateHostedZone
route53:GetHostedZone
route53:ListHostedZonesByVPC
route53:AssociateVPCWithHostedZone
route53:DisassociateVPCFromHostedZone
route53:CreateVPCAssociationAuthorization
route53:DeleteVPCAssociationAuthorization
route53:ListResourceRecordSets
route53:ChangeResourceRecordSets

route53:DeleteHostedZone
----

* The credentials specified in HiveConfig for associating VPCs to the private hosted zone
  (`.spec.awsPrivateLink.associatedVPCs[$idx].credentialsSecretRef`). The account where the VPC is located requires the following permissions:
+
----
route53:AssociateVPCWithHostedZone
route53:DisassociateVPCFromHostedZone
ec2:DescribeVPCs
----

. Ensure that there is a credential secret within the Hive namespace
+
The `HiveConfig` file needs to reference a credential within the Hive namespace that has permissions to create resources in a specific provided VPC. If the credential you are using to provision an AWS cluster in AWS Government is already in the Hive namespace, then you do not need to create another one. If the credential that you are using to provision an AWS cluster in AWS Government is not already in the Hive namespace, you can either replace your current credential or create an additional credential in the Hive namespace.
+
The `HiveConfig` file needs to be updated to include the following content:
+
* An AWS GovCloud credential that has the required permissions to provision resources for the given VPC.

* The addresses of the VPCs for the {ocp-short} cluster installation, as well as the service endpoints for the managed cluster. *Best practice:* Use different VPCs for the {ocp-short} cluster installation and the service endpoints.
+
The following example shows the credential content:
+
[source,yaml]
----
spec:
  awsPrivateLink:
    ## this this is list if inventory of VPCs that can be used to create VPC
    ## endpoints by the controller
    endpointVPCInventory:
    - region: us-east-1
      vpcID: vpc-1
      subnets:
      - availabilityZone: us-east-1a
        subnetID: subnet-11
      - availabilityZone: us-east-1b
        subnetID: subnet-12
      - availabilityZone: us-east-1c
        subnetID: subnet-13
      - availabilityZone: us-east-1d
        subnetID: subnet-14
      - availabilityZone: us-east-1e
        subnetID: subnet-15
      - availabilityZone: us-east-1f
        subnetID: subnet-16
    - region: us-east-1
      vpcID: vpc-2
      subnets:
      - availabilityZone: us-east-1a
        subnetID: subnet-21
      - availabilityZone: us-east-1b
        subnetID: subnet-22
      - availabilityZone: us-east-1c
        subnetID: subnet-23
      - availabilityZone: us-east-1d
        subnetID: subnet-24
      - availabilityZone: us-east-1e
        subnetID: subnet-25
      - availabilityZone: us-east-1f
        subnetID: subnet-26
    ## credentialsSecretRef points to a secret with permissions to create
    ## resources in account where the inventory of VPCs exist.
    credentialsSecretRef:
      name: <hub-account-credentials-secret-name>

    ## this is a list of VPC where various MCE clusters exists.
    associatedVPCs:
    - region: region-mce1
      vpcID: vpc-mce1
      credentialsSecretRef:
        name: <credentials-that-have-access-to-account-where-MCE1-VPC-exists>
    - region: region-mce2
      vpcID: vpc-mce2
      credentialsSecretRef:
        name: <credentials-that-have-access-to-account-where-MCE2-VPC-exists>
----
+
You can include VPC from all the regions where a private link is supported in the `endpointVPCInventory` list. The controller selects a VPC that meets the requirements for the ClusterDeployment.
+
For more information, refer to the https://github.com/openshift/hive/blob/master/docs/awsprivatelink.md#configuring-hive-to-enable-aws-private-link[Hive documentation].

[#aws-creating-your-cluster-with-the-console]
== Creating your cluster with the console

To create a cluster from the console, navigate to *Infrastructure* > *Clusters* > *Create cluster* *AWS* > *Standalone* and complete the steps in the console. 

*Note:* This procedure is for creating a cluster. If you have an existing cluster that you want to import, see xref:../cluster_lifecycle/import.adoc#importing-a-target-managed-cluster-to-the-hub-cluster[Importing a target managed cluster to the hub cluster] for those steps.

The credential that you select must have access to the resources in an AWS GovCloud region, if you create an AWS GovCloud cluster. If you need to create a credential, see xref:../credentials/credential_aws.adoc#creating-a-credential-for-amazon-web-services[Creating a credential for Amazon Web Services] for more information.

The name of the cluster is used in the hostname of the cluster.

*Important:* When you create a cluster, the controller creates a namespace for the cluster and its resources. Ensure that you include only resources for that cluster instance in that namespace. Destroying the cluster deletes the namespace and all of the resources in it.

*Tip:* Select *YAML: On* to view content updates as you enter the information in the console.

If you want to add your cluster to an existing cluster set, you must have the correct permissions on the cluster set to add it. If you do not have `cluster-admin` privileges when you are creating the cluster, you must select a cluster set on which you have `clusterset-admin` permissions. If you do not have the correct permissions on the specified cluster set, the cluster creation fails. Contact your cluster administrator to provide you with `clusterset-admin` permissions to a cluster set if you do not have any cluster set options to select.

Every managed cluster must be associated with a managed cluster set. If you do not assign the managed cluster to a `ManagedClusterSet`, it is automatically added to the `default` managed cluster set.

If there is already a base DNS domain that is associated with the selected credential that you configured with your AWS account, that value is populated in the field. You can change the value by overwriting it. This name is used in the hostname of the cluster. See https://access.redhat.com/documentation/en-us/openshift_container_platform/4.11/html/installing/installing-on-aws#installing-aws-account[Configuring an AWS account] for more information.

The release image identifies the version of the {ocp-short} image that is used to create the cluster. If the version that you want to use is available, you can select the image from the list of images. If the image that you want to use is not a standard image, you can enter the URL to the image that you want to use. See xref:../cluster_lifecycle/release_images.adoc#release-images[Release images] for more information about release images.

The node pools include the control plane pool and the worker pools. The control plane nodes share the management of the cluster activity. The information includes the following fields:

* Region: The region where you create your cluster resources. If you are creating a cluster on an AWS GovCloud provider, you must include an AWS GovCloud region for your node pools. For example, `us-gov-west-1`.

* CPU architecture: If the architecture type of the managed cluster is not the same as the architecture of your hub cluster, enter a value for the instruction set architecture of the machines in the pool. Valid values are _amd64_, _ppc64le_, _s390x_, and _arm64_.

* Zones: Specify where you want to run your control plane pools. You can select multiple zones within the region for a more distributed group of control plane nodes. A closer zone might provide faster performance, but a more distant zone might be more distributed.

* Instance type: Specify the instance type for your control plane node. You can change the type and size of your instance after it is created. 

* Root storage: Specify the amount of root storage to allocate for the cluster. 

You can create zero or more worker nodes in a worker pool to run the container workloads for the cluster. They can be in a single worker pool, or distributed across multiple worker pools. If zero worker nodes are specified, the control plane nodes also function as worker nodes. The optional information includes the following fields:

* Pool name: Provide a unique name for your pool.

* Zones: Specify where you want to run your worker pools. You can select multiple zones within the region for a more distributed group of nodes. A closer zone might provide faster performance, but a more distant zone might be more distributed.

* Instance type: Specify the instance type of your worker pools. You can change the type and size of your instance after it is created.

* Node count: Specify the node count of your worker pool. This setting is required when you define a worker pool.

* Root storage: Specify the amount of root storage allocated for your worker pool. This setting is required when you define a worker pool.

Networking details are required for your cluster, and multiple networks are required for using IPv6. For an AWS GovCloud cluster, enter the values of the block of addresses of the Hive VPC in the _Machine CIDR field. You can add an additional network by clicking *Add network*. 

Proxy information that is provided in the credential is automatically added to the proxy fields. You can use the information as it is, overwrite it, or add the information if you want to enable a proxy. The following list contains the required information for creating a proxy:  

* HTTP proxy URL: Specify the URL that should be used as a proxy for `HTTP` traffic. 

* HTTPS proxy URL: Specify the secure proxy URL that should be used for `HTTPS` traffic. If no value is provided, the same value as the `HTTP Proxy URL` is used for both `HTTP` and `HTTPS`.

* No proxy domains: A comma-separated list of domains that should bypass the proxy. Begin a domain name with a period `.` to include all of the subdomains that are in that domain. Add an asterisk `*` to bypass the proxy for all destinations. 

* Additional trust bundle: One or more additional CA certificates that are required for proxying HTTPS connections.

When creating an AWS GovCloud cluster or using a private environment, complete the fields on the _AWS private configuration_ page with the AMI ID and the subnet values.

Ensure that the value of `spec:platform:aws:privateLink:enabled` is set to `true` in the `ClusterDeployment.yaml` file.  

When you review your information and optionally customize it before creating the cluster, you can select *YAML: On* to view the `install-config.yaml` file content in the panel. You can edit the YAML file with your custom settings, if you have any updates.

*Note:* You do not have to run the `kubectl` command that is provided with the cluster details to import the cluster. When you create the cluster, it is automatically configured under the management of {mce}. 

Continue with xref:../cluster_lifecycle/access_cluster.adoc#accessing-your-cluster[Accessing your cluster] for instructions for accessing your cluster. 
