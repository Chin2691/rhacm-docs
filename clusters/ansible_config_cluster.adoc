[#ansible-config-cluster]
= Setting up Ansible Tower tasks with cluster installation and upgrades (Technology Preview)

{product-title-short} is integrated with Ansible Tower automation so that you can create prehook and posthook AnsibleJob instances that occur before or after creating or upgrading your clusters. Configuring prehook and posthook jobs for cluster destroy and cluster scale actions are not supported.

*Required access:* Cluster administrator

* <<prerequisites-for-ansible-integration-cluster,Prerequisites>>
* <<install-ansible-cluster,Install Ansible Automation Platform Resource Operator>>
* <<ansible-operator-components-cluster,Ansible operator components>>
* <<obtain-the-ansible-tower-credential-cluster,Obtain the Ansible Tower URL and credential>>
* <<ansible-configuration-cluster,Ansible configuration>>
* <<obtain-a-credential-cluster,Obtaining a credential>>
* <<ansible-operator-components,Ansible operator components>>
* <<ansible-integration-cluster,Ansible integration>>
* <<ansible-template-create-cluster,Creating and modifying an AnsibleJob template>>
* <<ansible-link-credential-cluster,Linking a credential to an AnsibleJob template>>
* <<ansible-template-run-cluster-console,Configuring an AnsibleJob template to run on a cluster-console>>
* <<configuring-an-ansible-job-for-a-managed-cluster-labels,Configuring an AnsibleJob template to run on a managed cluster by using labels>>
* <<ansible-status-job-cluster,Viewing the status of an Ansible job>>
* <<ansible-sample-yaml-cluster,Ansible sample YAML>>

[#prerequisites-for-ansible-integration-cluster]
== Prerequisites

You must meet the following prerequisites to run Ansible templates on your {product-title-short} clusters:

* {ocp-short} 4.6 or later

* You must have Ansible Tower version 3.7.3 or a later version installed. It is best practice to install the latest supported version of Ansible Tower. See https://docs.ansible.com/ansible-tower/[Red Hat Ansible Tower documentation] for more details.

* Install the Ansible Automation Platform Resource Operator to connect Ansible jobs to the lifecycle of Git subscriptions. For best results when using the AnsibleJob to launch Ansible Tower jobs, the Ansible Tower job template should be idempotent when it is run. 

Check `PROMPT ON LAUNCH` on the template for both INVENTORY and EXTRA VARIABLES. See https://docs.ansible.com/ansible-tower/latest/html/userguide/job_templates.html[Job templates] for more information.

[#install-ansible-cluster]
== Install Ansible Automation Platform Resource Operator

. Log in to your {ocp-short} cluster console.
. Click *OperatorHub* in the console navigation.
. Search for and install the _Ansible Automation Platform Resource Operator_.

[#ansible-operator-components-cluster]
=== Ansible operator components

When you create a subscription custom resource (CR), the Git-branch and Git-path points to a Git repository root location. In the Git root location, the two subfolders `prehook` and `posthook` should contain at least one `Kind:AnsibleJob` resource.

[#prehook]
==== Prehook

The application subscription controller searches all the `Kind:AnsibleJob` CRs in the prehook folder as the prehook AnsibleJob objects, then generates a new prehook AnsibleJob instance. The new instance name is the prehook AnsibleJob object name and a random suffix string. 

See an example instance name: `database-sync-1-2913063`.

The application subscription controller queues the reconcile request again in a 1 minute loop, where it checks the prehook AnsibleJob `status.ansibleJobResult`. When the prehook `status.ansibleJobResult.status` is `successful`, the application subscription continues to deploy the main subscription.

[#posthook]
==== Posthook

When the app subscription status is updated, if the subscription status is subscribed or propagated to all target clusters in subscribed status, the app subscription controller searches all of the `AnsibleJob` `Kind` CRs in the posthook folder as the posthook AnsibleJob objects. Then, it generates new posthook `AnsibleJob` instances. The new instance name is the posthook `AnsibleJob` object name and a random suffix string. 

See an example instance name: `service-ticket-1-2913849`.

[#ansible-placement-rule]
==== Ansible placement rules

With a valid prehook AnsibleJob, the subscription launches the prehook AnsibleJob regardless of the decision from the placement rule. For example, you can have a prehook AnsibleJob that failed to propagate a placement rule subscription. When the placement rule decision changes, new prehook and posthook AnsibleJob instances are created.

[#ansible-integration-cluster]
== Ansible integration 

You can integrate Ansible Tower jobs so they can be run before or after a cluster is installed.

The application subscription operator is enhanced to define two subfolders: `prehook` and `posthook`. Both folders are in the Git repository resource root path and contain all prehook and posthook Ansible jobs, respectively.

When the Git subscription is created, all of the pre and post AnsibleJob resources are parsed and stored in memory as an object. The application subscription controller decides when to create the pre and post AnsibleJob instances.

[#obtain-the-ansible-tower-credential-cluster]
== Obtain the Ansible Tower URL and credential

The Ansible Tower URL is the same URL that is used to log in to Tower. This is required for the credential or the Tower access secret when configuring a cluster to run jobs with Ansible prehooks and posthooks. 

See the following example URL: `https://ansible-tower-web-svc-tower.apps.my-openshift-cluster.com`. 

[#ansible-configuration-cluster]
== Ansible configuration

You can configure Ansible Tower configurations with the following tasks:

[#ansible-secrets]
=== Ansible secrets

You must create an Ansible Tower secret CR in the same subscription namespace. The Ansible Tower secret is limited to the same subscription namespace.

Create the secret from the console by filling in the `Ansible Tower secret name` section. To create the secret using terminal, edit and apply the following `yaml`:
 
Run the following command to add your YAML file:

----
oc apply -f
----

See the following YAML sample:

*Note:* The `namespace` is the same namespace as the subscription namespace. The `stringData:token` and `host` are from the Ansible Tower.

[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: toweraccess
  namespace: same-as-subscription
type: Opaque
stringData:
  token: ansible-tower-api-token
  host: https://ansible-tower-host-url
----

When the app subscription controller creates prehook and posthook AnsibleJobs, if the secret from subscription `spec.hooksecretref` is available, then it is sent to the AnsibleJob CR `spec.tower_auth_secret` and the AnsibleJob can access the Ansible Tower.

[#ansible-secret-reconciliation]
== Set secret reconciliation

For a main-sub subscription with prehook and posthook AnsibleJobs, the main-sub subscription should be reconciled after all prehook and posthook AnsibleJobs or main subscription are updated in the Git repository. 

Prehook AnsibleJobs and the main subscription continuously reconcile and relaunch a new pre-AnsibleJob instance.

. After the pre-AnsibleJob is done, re-run the main subscription. 
. If there is any specification change in the main subscription, re-deploy the subscription. The main subscription status should be updated to align with the redeployment procedure. 
. Reset the hub subscription status to `nil`. The subscription is refreshed along with the subscription deployment on target clusters. 

+
When the deployment is finished on the target cluster, the subscription status on the target cluster is updated to `"subscribed"` or `"failed"`, and is synced to the hub cluster subscription status.

. After the main subscription is done, relaunch a new post-AnsibleJob instance.

. Verify that the DONE subscription is updated. See the following output:

- subscription.status == `"subscribed"`
- subscription.status == `"propagated"` with all of the target clusters `"subscribed"`

When an AnsibleJob CR is created, A Kubernetes job CR is created to launch an Ansible Tower job by communicating to the target Ansible Tower. When the job is complete, the final status for the job is returned to AnsibleJob `status.ansibleJobResult`. 

*Notes:* 

The AnsibleJob status.conditions is reserved by the Ansible Job operator for storing the creation of Kubernetes job result. The status.conditions does not reflect the actual Ansible Tower job status. 

The subscription controller checks the Ansible Tower job status by the `AnsibleJob.status.ansibleJobResult` instead of `AnsibleJob.status.conditions`.

As previously mentioned in the prehook and posthook AnsibleJob workflow, when the main subscription is updated in Git repository, a new prehook and posthook AnsibleJob instance is created. As a result, one main subscription can link to multiple AnsibleJob instances. 

Four fields are defined in subscription.status.ansibleJobs:

- lastPrehookJobs: The most recent prehook AnsibleJobs
- prehookJobsHistory: All the prehook AnsibleJobs history
- lastPosthookJobs: The most recent posthook AnsibleJobs
- posthookJobsHistory: All the posthook AnsibleJobs history

[#obtain-a-credential-cluster]
== Obtaining a credential

See the procedure in link:../credentials/credential_ansible.adoc#credential_ansible[Obtaining an Ansible credential] for the steps describing how to find your token on the Ansible Tower.

[#ansible-template-create-cluster]
== Creating and modifying an AnsibleJob template

To trigger an Ansible job with a cluster installation or upgrade, you must create an Ansible job template to specify when you want the jobs to run. They can be configured to run before or after the cluster installs or upgrades.

To specify the details about running the Ansible template while creating a template, complete the following steps:

. Select *Infrastructure* > *Automation* from the {product-title-short} navigation. The existing Ansible templates are displayed.

. Select the appropriate path for your situation:  
+
* If you want to create a new template, click *Create Ansible template* and continue with step 3.

* If you want to modify an existing template, click *Edit template* from the _Options_ menu of the template that you want to modify and continue with step 5.

. Enter a name for your template. It must be a unique name that contains lowercase, alphanumeric characters or `-`.

. Select the credential that you want to use for the new template. 

. If you want to trigger any Ansible jobs before the cluster is installed, select *Add an Ansible job template* in the _Pre-install Ansible job templates_ section.

. Select the prehook and posthook Ansible jobs to add to the installation or upgrade of the cluster. 
+
*Note:* The _Ansible job template name_ must match the name of the Ansible job on the Ansible Tower.

. Enter any *Extra variables* that are required by the Ansible Tower job, if there are any.

. Drag the Ansible jobs to change the order, if necessary.  

. Click *Save* to commit your information. 

. Repeat steps 5 - 9 for any Ansible job templates that you want to trigger after the cluster is installed in the _Post-install Ansible job templates_ section.

. Click *Save* to commit your information. 

. Click *Next* to begin specifying the Ansible jobs for the _Upgrading_ triggers. 

. Complete steps 5 - 9 for any Ansible job templates that you want to trigger before the cluster is upgraded in the _Pre-upgrade Ansible job templates_ section.

. Click *Save* to commit your information. 
 
. Complete steps 5 - 9 for any Ansible job templates that you want to trigger after the cluster is upgraded in the _Post-upgrade Ansible job templates_ section.
 
. Click *Save* to commit your information. 

. Click *Next* to review the Ansible jobs that you added.

. Select *Add* to add the Ansible job configuration information to your template. 

Your Ansible template is configured to run on clusters that specify this template when the triggers occur. 

[#ansible-link-credential-cluster]
== Linking a credential to an AnsibleJob template

You must link an Ansible template to an Ansible credential that is in the same namespace as the template to run the Ansible jobs. If you do not link a credential, the Ansible template cannot access the Ansible Tower to run the jobs.  

To link an Ansible credential to an Ansible template, complete the following steps:
 
. From the {product-title-short} navigation, select *Automation*. Any template in the list of templates that is not linked to a credential contains a *Link to credential* icon that you can use to link the template to an existing credential.

. Select *Link to credential* to find and link to an existing credential.

. Select an available credential from the menu in the _Ansible Automation Platform credential_ field. Only the credentials in the same namespace as the template are displayed.  

. If there are no credentials that you can select, or if you do not want to use an existing credential, select *Edit template* from the _Options_ menu for the template that you want to link.

. Click *Add credential* to create a credential for your template. 

. Complete the procedure in link:../credentials/credential_ansible.adoc#creating-a-credential-for-ansible[Creating a credential for Ansible Automation Platform] to create your credential.

. After you create your credential in the same namespace as the template, select the credential in the _Ansible Automation Platform credential_ field when you edit the template. 

. Click *Save* to commit the link between the credential and the template.

The credential is linked to the template. 

[#ansible-template-run-cluster-console]
== Configuring an AnsibleJob template to run on a cluster by using the console

You must specify the Ansible job template that you want to use for a cluster when you create the cluster. To specify the template when creating a cluster, select the Ansible template that you want to apply to the cluster in the _Automation_ step. If there are no Ansible templates, click *Add automation template* to create one.

[#cconfiguring-an-ansible-job-for-a-managed-cluster-labels]
= Configuring an AnsibleJob template to run on a managed cluster by using labels

You can create an `AnsibleJob` that is bound to a cluster when the cluster is created by {product-title} or imported to be managed by {product-title-short} by using labels.

Complete the following procedure to create an Ansible job and configure it with a cluster that is not yet managed by {product-title-short}:

. Create the definition file for the Ansible job in one of the channels that are supported by the application function. Only Git channels are supported.
+
Use `AnsibleJob` as the value of `kind` in the definition.
+
Your definition file contents might resemble the following example:
+
[source,yaml]
----
apiVersion: apiVersion: tower.ansible.com/v1alpha1
kind: AnsibleJob
metadata:
  name: hive-cluster-gitrepo
spec:
  tower_auth_secret: my-toweraccess
  job_template_name: my-tower-template-name
  extra_vars:
    variable1: value1
    variable2: value2
----
+
By storing the file in the prehook or posthook directory, it creates a list of cluster names that match the placement rule. The list of cluster names can be passed as a value of `extra_vars` to the `AnsibleJob` `kind` resource. When this value is passed to the `AnsibleJob` resource, the Ansible job can determine the new cluster name and use it in the automation.

. Log on to your {product-title-short} hub cluster.

. Using the {product-title-short} console, create an application with a Git subscription that references the channel where you stored the definition file that you just created. See link:../applications/app_resources.adoc#managing-application-resources[Managing application resources] for more information about creating an application and subscription.
+
When you create the subscription, specify a label that you can add to the cluster that you create or import later to connect this subscription with the cluster. This can be an existing label, like `vendor=OpenShift`, or a unique label that you create and define. 
+
*Note:* If you select any label that is already in use, the Ansible job automatically runs. It is recommended that you include a resource in your application that is not part of the prehooks or posthooks.  
+
The default placement rule runs the job when it detects the cluster with the label that matches the label of the `AnsibleJob`. If you want the automation to run on all of your running clusters that are managed by the hub cluster, add the following content to the placement rule:
+
[source,yaml]
----
clusterConditions:
  - type: ManagedClusterConditionAvailable
    status: "True"
----
+
You can either paste this into the YAML content of the placement rule or you can select the option to _Deploy to all online clusters and local cluster_ on the _Application create_ page of the {product-title-short} console. 

. Create or import your cluster by following the instructions in xref:../clusters/create.adoc#creating-a-cluster[Creating a cluster] or xref:../clusters/import.adoc#importing-a-target-managed-cluster-to-the-hub-cluster[Importing a target managed cluster to the hub cluster], respectively.
+
When you create or import the cluster, use the same label that you used when you created the subscription, and the `AnsibleJob` is automatically configured to run on the cluster. 
 
{product-title-short} automatically injects the cluster name into the `AnsibleJob.extra_vars.target_clusters` path. You can dynamically inject the cluster name into the definition. Complete the following procedure to create an AnsibleJob and configure it with a cluster that is already managed by {product-title-short}:

. Create the definition file for the AnsibleJob in the prehook or posthook directory of your Git Channel.
+
Use `AnsibleJob` as the value of `kind` in the definition.
+
Your definition file contents might resemble the following example:
+
[source,yaml]
----
apiVersion: tower.ansible.com/v1alpha1
kind: AnsibleJob
metadata:
  name: hive-cluster-gitrepo
spec:
  tower_auth_secret: my-toweraccess
  job_template_name: my-tower-template-name
  extra_vars:
    variable1: value1
    variable2: value2
----
Replace `_my-toweraccess_` with the authentication secret to access your Ansible Tower.
Replace `_my-tower-template-name_` with the template name from your Ansible Tower.

Each time a cluster that is controlled by the Ansible job is removed or added, the AnsibleJob automatically runs and updates the `extra_vars.target_clusters` variable. This updating provides the ability to specify cluster names with a specific automation, or apply the automation to a group of clusters. 

[#ansible-status-job-cluster]
== Viewing the status of an Ansible job

You can view the status of a running Ansible job to ensure that it started, and is running successfully. To view the current status of a running Ansible job, complete the following steps: 

. In the {product-title-short} menu, select *Infrastructure* > *Clusters* to access the _Cluster overview_ page.

. View the status of the last run of the Ansible job on the cluster information. The entry shows one of the following statuses:
+
* When an install prehook or posthook job fails, the cluster status shows `Failed`.
* When an upgrade prehook or posthook job fails, a warning is displayed in the _Distribution_ field the the upgrade failed.
+
*Tip:* You can retry an upgrade form the _Cluster overview_ page if the cluster prehook or posthook failed.  

[#ansible-sample-yaml]
== Ansible sample YAML 

See the following sample of an AnsibleJob `.yaml` file in a Git prehook and posthook folder:

[source,yaml]
----
apiVersion: tower.ansible.com/v1alpha1
kind: AnsibleJob
metadata:
  generateName: demo-job-001
  namespace: default
spec:
  tower_auth_secret: toweraccess
  job_template_name: Demo Job Template
  extra_vars:
    cost: 6.88
    ghosts: ["inky","pinky","clyde","sue"]
    is_enable: false
    other_variable: foo
    pacman: mrs
    size: 8
    targets_list:
    - aaa
    - bbb
    - ccc
    version: 1.23.45
----

