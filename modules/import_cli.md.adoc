[#importing-a-managed-cluster-with-the-cli]
= Importing a managed cluster with the CLI

Under construction.

After you install Red Hat Advanced Cluster Management for Kubernetes, you are ready to import a cluster to manage.

* <<prerequisites,Prerequisites>>
* <<supported-architecture,Supported architecture>>
* <<prepare-for-import,Prepare for import>>
* <<importing-the-multicluster-endpoint,Importing the multicluster-endpoint>>

NOTE: A hub cluster cannot manage another hub cluster.

[#prerequisites]
== Prerequisites

* You must have an Red Hat Advanced Cluster Management for Kubernetes hub that is deployed and cluster that you want to manage.
* You need to install the Kubernetes CLI, `kubectl`.
To install `kubectl`, see _Install and Set Up kubectl_ in the https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-macos[Kubernetes documentation].
+
NOTE: Download the installation file for CLI tools from the console.

[#supported-architecture]
== Supported architecture

* Linux
* macOS

[#prepare-for-import]
== Prepare for import

. Log in to your _hub cluster_.
Run the following command:

----
  oc login
----

. Run the following command on the hub cluster to create the `oc create ns <cluster_namespace>` namespace:

----
  oc create -n ${CLUSTER_NAMESPACE} secret docker-registry quay-secret --docker-server=quay.io --docker-username=${DOCKER_USER} --docker-password=${DOCKER_PASS}
----

. Edit the example ClusterRegistry cluster in the `/test/resources/test_cluster.yaml` file of the `open-cluster-management` https://github.com/open-cluster-management/rcm-controller/blob/master/test/resources/test_cluster.yaml[repository]
. Add the following `imagePullSecret`: `quay-secret in test_endpoint_config.yaml`
 ** Create a ClusterRegistry cluster: `oc apply -f test_cluster.yaml`
 ** Refer to the https://github.com/kubernetes/cluster-registry/blob/master/pkg/apis/clusterregistry/v1alpha1/types.go[cluster-registry] for API definition
. Create the endpoint configuration.
Edit the [example EndpointConfig resourcehttps://github.com/open-cluster-management/rcm-controller/blob/master/test/resources/test_endpoint_config.yaml[/test/resources/test_endpoint_config.yaml].
. Refer to https://github.com/open-cluster-management/rcm-controller/blob/master/pkg/apis/multicloud/v1alpha1/endpointconfig_types.go[/pkg/apis/multicloud/v1alpha1/endpointconfig_types.go] and https://github.com/open-cluster-management/endpoint-operator/blob/master/pkg/apis/multicloud/v1beta1/endpoint_types.go[endpoint-operator - /pkg/apis/multicloud/v1beta1/endpoint_types.go] for API definition.
. Create a Multicloud EndpointConfig.
Run the following command:

----
  oc apply -f test_endpoint_config.yaml
----

The ClusterController takes the following actions:

* EndpointConfig creation triggers `Reconcile()` in https://github.com/open-cluster-management/rcm-controller/blob/master/pkg/controller/endpointconfig/endpointconfig_controller.go[/pkg/controllers/endpointconfig/endpointconfig_controller.go].
* Controller uses information in EndpointConfig to generate a secret named `+{cluster-name}-import+`.
* The `+{cluster-name}-import+` secret contains the `import.yaml` that the user applies to a managed cluster to install `multicluster-endpoint`.

[#importing-the-multicluster-endpoint]
== Importing the multicluster-endpoint

. Obtain the `import.yaml` that was generated by the cluster controller.

* For macOS, run the following command:
+
[source,bash]
----
kubectl get secret ${cluster_name}-import -n ${cluster_namespace} -o jsonpath={.data.import\\.yaml} | base64 -D > import.yaml
----

* For Linux, run the following command:
+
[source,bash]
----
kubectl get secret ${cluster_name}-import -n ${cluster_namespace} -o jsonpath={.data.import\\.yaml} | base64 -d > import.yaml
----

. Login to your target managed cluster.
. Apply the `import.yaml` generated in previous step.
Run the following command:

----
  kubectl apply -f import.yaml --validate=false
----

. Validate the pod status on the target managed cluster.
Run the following command:

----
  kubectl get pod -n multicluster-endpoint
----

. Check the cluster on the hub cluster.
Run the following command:
+
----
kubectl get cluster --all-namespaces
----
