== Custom Metrics

Adding to the
https://book.kubebuilder.io/reference/metrics-reference.html#default-exported-metrics-references[default
exported metrics by the controller-runtime].

=== Hub Cluster Custom Metrics

The following metrics can be scrapped from _Hub Cluster_:

[width="100%",cols="37%,56%,7%",options="header",]
|===
|Name |Help |Labels
|propagation_successful_time |Histogram of successful propagation
latency |_subscription_namespace__subscription_name_

|propagation_failed_time |Histogram of failed propagation latency
|_subscription_namespace__subscription_name_
|===

=== Managed Cluster Custom Metrics

The following metrics can be scrapped from _Managed Clusters_:

[width="100%",cols="39%,55%,6%",options="header",]
|===
|Name |Help |Labels
|git_successful_pull_time |Histogram of successful git pull latency
|_subscription_namespace__subscription_name_

|git_failed_pull_time |Histogram of failed git pull latency
|_subscription_namespace__subscription_name_

|local_deployment_successful_time |Histogram of successful local
deployment latency |_subscription_namespace__subscription_name_

|local_deployment_failed_time |Histogram of failed local deployment
latency |_subscription_namespace__subscription_name_
|===

=== Collecting Custom Metrics for Observability

For the
https://github.com/stolostron/multicluster-observability-operator[Observability
Operator] to collect the aforementioned metrics, we need to configure
the `+observability-metrics-custom-allowlist+` _ConfigMap_ in the
`+open-cluster-management-observability+` namespace on the _Hub
Cluster_. Note that for _Histogram_ type metrics, we have a 3 metrics
series created per each _Histogram_, the members of the series are
identified by the _bucket_, _count_, and _sum_ suffixes to the metric
name. Hereâ€™s an example of a working _ConfigMap_:

[source,yaml]
----
apiVersion: v1
kind: ConfigMap
data:
  metrics_list.yaml: |
    names:
    - git_successful_pull_time_bucket
    - git_successful_pull_time_count
    - git_successful_pull_time_sum
    - git_failed_pull_time_bucket
    - git_failed_pull_time_count
    - git_failed_pull_time_sum
    - local_deployment_successful_time_bucket
    - local_deployment_successful_time_count
    - local_deployment_successful_time_sum
    - local_deployment_failed_time_bucket
    - local_deployment_failed_time_count
    - local_deployment_failed_time_sum
    - propagation_successful_time_bucket
    - propagation_successful_time_count
    - propagation_successful_time_sum
    - propagation_failed_time_bucket
    - propagation_failed_time_count
    - propagation_failed_time_sum
----
