[#metrics]
= Using the metrics service

You can use metrics to monitor component health across {product-title}.

[#accessing-hub-metrics]
== Accessing the hub cluster metrics service

To view the collected metrics, you must expose the metrics service on the hub cluster. If your metrics are already exposed in the Grafana dashboard, this procedure is optional.

From the {ocp-short} console, find the metrics service. Click *Observe* > *Metrics*.

[#scrapping-prometheus]
== Scrapping with Prometheus

You can use Prometheus to expose metrics that are not exposed from the product console.

[#scrapping-hub]
== Scrapping the hub cluster

See the following procedure to expose metrics. These files are within the `openshift-monitoring` namespace:

. Create a `ServiceMonitor` for collecting services and exposing metrics. See the following example:

+
[source,yaml]
----
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: hub-subscription-metrics
  namespace: monitoring
spec:
  endpoints:
  - port: metrics
  namespaceSelector:
    matchNames:
    - open-cluster-management
  selector:
    matchLabels:
      app: hub-subscription-metrics
----

. Run the following command to apply the file:

+
----
oc apply -f
----

. Create a _Role_ for setting the permissions for monitoring. See the following YAML file:

+
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: prometheus-k8s-monitoring
  namespace: open-cluster-management
rules:
- apiGroups:
  - ""
  resources:
  - services
  - endpoints
  - pods
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - extensions
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
----

. Run the following command to apply the file:

+
----
oc apply -f
----

. Create a _RoleBinding_ for Binding the _Role_ to the Prometheus monitoring
`ServiceAccount`, as it is in the following example:

+
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: prometheus-k8s-monitoring-binding
  namespace: open-cluster-management
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prometheus-k8s-monitoring
subjects:
- kind: ServiceAccount
  name: prometheus-k8s
  namespace: monitoring
----

. Run the following command to apply the file:

+
----
oc apply -f
----

. Verify dashboard, run the following query to look up
metrics reported by the Subscription Operator Metrics Service:

----
{service="hub-subscription-metrics"}
----

[#scrapping-managed]
== Scrapping the managed cluster

. Create a _ServiceMonitor_ for collecting services exposing metrics:

[source,yaml]
----
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: mc-subscription-metrics
  namespace: monitoring
spec:
  endpoints:
  - port: metrics
  namespaceSelector:
    matchNames:
    - open-cluster-management-agent-addon
  selector:
    matchLabels:
      app: mc-subscription-metrics
----

. Run the following command:
+
----
oc apply -f
----

. Create a _Role_ for setting the permissions for monitoring:

+
[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: prometheus-k8s-monitoring
  namespace: open-cluster-management-agent-addon
rules:
- apiGroups:
  - ""
  resources:
  - services
  - endpoints
  - pods
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - extensions
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
----

. Run the following command:
+
----
oc apply -f
----

. Create a _RoleBinding_ for Binding the _Role_ to Prometheus’ monitoring
_ServiceAccount_:

[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: prometheus-k8s-monitoring-binding
  namespace: open-cluster-management-agent-addon
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prometheus-k8s-monitoring
subjects:
- kind: ServiceAccount
  name: prometheus-k8s
  namespace: monitoring
----

. Run the following command:

+
----
oc apply -f
----

. Verify In `Prometheus` dashboard, run the following query to look up
metrics reported by the Subscription Operator Metrics Service:

----
{service="mc-subscription-metrics"}
----

[#scrapping-standalone]
== Scrapping the standalone cluster

. Create a _ServiceMonitor_ for collecting services exposing metrics:

____
Note: for _OCP_ _metadata.namespace_ should be `+openshift-monitoring+`.
____


[source,yaml]
----
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: standalone-subscription-metrics
  namespace: monitoring
spec:
  endpoints:
  - port: metrics
  namespaceSelector:
    matchNames:
    - open-cluster-management
  selector:
    matchLabels:
      app: standalone-subscription-metrics
----

. Create a _Role_ for setting the permissions for monitoring:

----
oc apply -f
----

[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: prometheus-k8s-monitoring
  namespace: open-cluster-management
rules:
- apiGroups:
  - ""
  resources:
  - services
  - endpoints
  - pods
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - extensions
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
EOF
----

. Create a _RoleBinding_ for Binding the _Role_ to Prometheus’ monitoring
_ServiceAccount_:

____
Note: for _OCP_ _subjects[0].namespace_ should be
`+openshift-monitoring+`.
____

----
oc apply -f
----

[source,yaml]
----
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: prometheus-k8s-monitoring-binding
  namespace: open-cluster-management
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: prometheus-k8s-monitoring
subjects:
- kind: ServiceAccount
  name: prometheus-k8s
  namespace: monitoring
----

. Verify which metrics are reported by the Subscription Operator Metrics Service from the _Prometheus_ dashboard. Run the following command:

----
{service="standalone-subscription-metrics"}
----
